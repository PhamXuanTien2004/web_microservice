{
  "info": {
    "name": "Auth Service - Admin Tests",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "base_url", "value": "http://localhost:5001" },
    { "key": "admin_token", "value": "" },
    { "key": "user_token", "value": "" },
    { "key": "refresh_token", "value": "" },
    { "key": "logged_out_token", "value": "" }
  ],
  "item": [
    {
      "name": "Setup",
      "item": [
        {
          "name": "1. Login Admin",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Có access_token', () => {",
                  "  const b = pm.response.json();",
                  "  pm.expect(b.success).to.be.true;",
                  "  pm.expect(b.data.access_token).to.be.a('string');",
                  "});",
                  "pm.test('Role là admin', () => {",
                  "  pm.expect(pm.response.json().data.user.role).to.equal('admin');",
                  "});",
                  "const b = pm.response.json();",
                  "if (b.success) {",
                  "  pm.collectionVariables.set('admin_token', b.data.access_token);",
                  "  pm.collectionVariables.set('refresh_token', b.data.refresh_token);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": "{{base_url}}/api/auth/login"
          }
        },
        {
          "name": "2. Login User Thường",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Role là user', () => {",
                  "  pm.expect(pm.response.json().data.user.role).to.equal('user');",
                  "});",
                  "const b = pm.response.json();",
                  "if (b.success) pm.collectionVariables.set('user_token', b.data.access_token);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"john_doe\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": "{{base_url}}/api/auth/login"
          }
        }
      ]
    },
    {
      "name": "Admin Functions",
      "item": [
        {
          "name": "3. Admin Tạo User Mới ✅",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 201 Created', () => pm.response.to.have.status(201));",
                  "pm.test('Tạo thành công', () => {",
                  "  const b = pm.response.json();",
                  "  pm.expect(b.success).to.be.true;",
                  "  pm.expect(b.data.user.username).to.equal('sensor_operator');",
                  "});",
                  "pm.test('Không có password trong response', () => {",
                  "  const u = pm.response.json().data.user;",
                  "  pm.expect(u).to.not.have.property('password_hash');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"sensor_operator\",\n  \"email\": \"operator@company.com\",\n  \"password\": \"Operator123!\",\n  \"phone\": \"+84901111222\"\n}"
            },
            "url": "{{base_url}}/api/auth/register"
          }
        },
        {
          "name": "4. Admin Xem /me",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Đúng thông tin admin', () => {",
                  "  const u = pm.response.json().data.user;",
                  "  pm.expect(u.role).to.equal('admin');",
                  "  pm.expect(u.username).to.equal('admin');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "url": "{{base_url}}/api/auth/me"
          }
        },
        {
          "name": "5. Admin Refresh Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Có token mới', () => {",
                  "  const b = pm.response.json();",
                  "  pm.expect(b.data.access_token).to.be.a('string');",
                  "  pm.expect(b.data.access_token).to.not.equal(pm.collectionVariables.get('admin_token'));",
                  "});",
                  "const b = pm.response.json();",
                  "if (b.success) pm.collectionVariables.set('admin_token', b.data.access_token);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{refresh_token}}" }] },
            "url": "{{base_url}}/api/auth/refresh"
          }
        },
        {
          "name": "6. Admin Validate Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Token hợp lệ và đúng role', () => {",
                  "  const d = pm.response.json().data;",
                  "  pm.expect(d.valid).to.be.true;",
                  "  pm.expect(d.role).to.equal('admin');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "url": "{{base_url}}/api/auth/validate-token"
          }
        },
        {
          "name": "7. Admin Đăng Xuất",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.to.have.status(200));",
                  "pm.test('Đăng xuất thành công', () => pm.expect(pm.response.json().success).to.be.true);",
                  "pm.collectionVariables.set('logged_out_token', pm.collectionVariables.get('admin_token'));",
                  "pm.collectionVariables.set('admin_token', '');"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refresh_token\": \"{{refresh_token}}\"\n}"
            },
            "url": "{{base_url}}/api/auth/logout"
          }
        }
      ]
    },
    {
      "name": "Error Cases",
      "item": [
        {
          "name": "8. Không Có Token → 401",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 401', () => pm.response.to.have.status(401));",
                  "pm.test('MISSING_TOKEN', () => pm.expect(pm.response.json().error.code).to.equal('MISSING_TOKEN'));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"hacker\",\n  \"email\": \"hacker@evil.com\",\n  \"password\": \"Hacker123!\"\n}"
            },
            "url": "{{base_url}}/api/auth/register"
          }
        },
        {
          "name": "9. User Thường Tạo User → 403",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 403', () => pm.response.to.have.status(403));",
                  "pm.test('FORBIDDEN', () => pm.expect(pm.response.json().error.code).to.equal('FORBIDDEN'));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{user_token}}" }] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"unauthorized\",\n  \"email\": \"unauth@example.com\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": "{{base_url}}/api/auth/register"
          }
        },
        {
          "name": "10. Dữ Liệu Sai → 400",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 400', () => pm.response.to.have.status(400));",
                  "pm.test('VALIDATION_ERROR có details', () => {",
                  "  const b = pm.response.json();",
                  "  pm.expect(b.error.code).to.equal('VALIDATION_ERROR');",
                  "  pm.expect(b.error.details).to.be.an('object');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"ab\",\n  \"email\": \"not-an-email\",\n  \"password\": \"123\"\n}"
            },
            "url": "{{base_url}}/api/auth/register"
          }
        },
        {
          "name": "11. Username Trùng → 409",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 409', () => pm.response.to.have.status(409));",
                  "pm.test('DUPLICATE_USERNAME', () => pm.expect(pm.response.json().error.code).to.equal('DUPLICATE_USERNAME'));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{admin_token}}" }] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"email\": \"another@example.com\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": "{{base_url}}/api/auth/register"
          }
        },
        {
          "name": "12. Token Sau Logout → 401",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 401', () => pm.response.to.have.status(401));",
                  "pm.test('TOKEN_REVOKED', () => pm.expect(pm.response.json().error.code).to.equal('TOKEN_REVOKED'));"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{logged_out_token}}" }] },
            "url": "{{base_url}}/api/auth/me"
          }
        },
        {
          "name": "13. Sai Password → 401",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 401', () => pm.response.to.have.status(401));",
                  "pm.test('INVALID_CREDENTIALS', () => pm.expect(pm.response.json().error.code).to.equal('INVALID_CREDENTIALS'));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"WrongPassword!\"\n}"
            },
            "url": "{{base_url}}/api/auth/login"
          }
        }
      ]
    }
  ]
}